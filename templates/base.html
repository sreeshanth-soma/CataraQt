<!DOCTYPE html>
<html lang="en" class="{{ 'dark' if session.get('theme') == 'dark' else '' }}">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}CataraQt{% endblock %}</title>
    <link
      href="{{ url_for('static', filename='css/output.css') }}"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      rel="icon"
      href="{{ url_for('static', filename='images/logo/logo.jpg') }}"
      type="image/jpeg"
    />
    <link
      rel="shortcut icon"
      href="{{ url_for('static', filename='images/logo/logo.jpg') }}"
      type="image/jpeg"
    />
    <link
      rel="apple-touch-icon"
      href="{{ url_for('static', filename='images/logo/logo.jpg') }}"
    />
    {% block head_extra %}{% endblock %}
    <style>
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .animate-fade-up {
        animation: fadeInUp 0.5s ease-out forwards;
      }

      .animate-slide-right {
        animation: slideInRight 0.5s ease-out forwards;
      }

      .nav-link {
        @apply px-3 py-2 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-150;
      }

      .nav-link.active {
        @apply bg-blue-100 dark:bg-gray-700 text-blue-700 dark:text-white font-semibold;
      }

      .btn-primary {
        @apply px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-300 shadow-sm;
      }

      .btn-secondary {
        @apply px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition-colors duration-300 shadow-sm;
      }

      .dark .btn-secondary {
        @apply bg-gray-600 text-gray-100 hover:bg-gray-500 focus:ring-gray-500;
      }

      /* Modern color scheme */
      .text-blue-600 {
        color: #4f46e5 !important;
      }

      .hover\:text-blue-700:hover {
        color: #4338ca !important;
      }

      .hover\:text-blue-600:hover {
        color: #4f46e5 !important;
      }

      .bg-blue-600 {
        background-color: #4f46e5 !important;
      }

      .hover\:bg-blue-700:hover {
        background-color: #4338ca !important;
      }

      .border-blue-500 {
        border-color: #6366f1 !important;
      }

      /* Dark mode styles */
      .dark body {
        background-color: #0f172a;
        color: #e2e8f0;
      }

      /* Navigation and general UI */
      .dark .bg-white {
        background-color: #1e293b;
      }

      .dark .text-gray-500 {
        color: #94a3b8;
      }

      .dark .text-gray-700 {
        color: #e2e8f0;
      }

      .dark .text-gray-800 {
        color: #f7fafc;
      }

      .dark .text-gray-900 {
        color: #f7fafc;
      }

      .dark .text-gray-400 {
        color: #a0aec0;
      }

      /* Cards and containers */
      .dark .bg-white\/80 {
        background-color: rgba(30, 41, 59, 0.8);
      }

      .dark .bg-white\/90 {
        background-color: rgba(30, 41, 59, 0.9);
      }

      .dark .bg-gray-50 {
        background-color: #0f172a;
      }

      .dark .bg-gray-100 {
        background-color: #1e293b;
      }

      .dark .bg-gray-200 {
        background-color: #334155;
      }

      /* Update nav links in dark mode */
      .dark .text-blue-600,
      .dark .hover\:text-blue-600:hover {
        color: #818cf8 !important;
      }

      .dark .bg-blue-600 {
        background-color: #6366f1 !important;
      }

      .dark .hover\:bg-blue-700:hover {
        background-color: #4f46e5 !important;
      }

      /* Interactive elements */
      .dark .hover\:bg-gray-50:hover {
        background-color: #2d2d2d;
      }

      .dark .hover\:bg-gray-100:hover {
        background-color: #374151;
      }

      .dark .hover\:text-gray-500:hover {
        color: #e2e8f0;
      }

      .dark .hover\:bg-white\/70:hover {
        background-color: rgba(45, 45, 45, 0.7);
      }

      /* Form elements */
      .dark input,
      .dark textarea {
        background-color: #2d2d2d;
        border-color: #4a5568;
        color: #e2e8f0;
      }

      .dark input:focus,
      .dark textarea:focus {
        border-color: #63b3ed;
      }

      /* Tables */
      .dark table {
        background-color: #2d2d2d;
        color: #e2e8f0;
      }

      .dark th {
        background-color: #374151;
      }

      .dark td {
        border-color: #4a5568;
      }

      /* Alert messages */
      .dark .bg-red-100 {
        background-color: rgba(220, 38, 38, 0.2);
      }

      .dark .text-red-700 {
        color: #f87171;
      }

      .dark .bg-green-100 {
        background-color: rgba(16, 185, 129, 0.2);
      }

      .dark .text-green-700 {
        color: #34d399;
      }

      /* Dashboard specific */
      .dark .bg-blue-50 {
        background-color: rgba(59, 130, 246, 0.1);
      }

      .dark .bg-yellow-50 {
        background-color: rgba(251, 191, 36, 0.1);
      }

      .dark .bg-green-50 {
        background-color: rgba(16, 185, 129, 0.1);
      }

      .dark .bg-red-50 {
        background-color: rgba(239, 68, 68, 0.1);
      }

      /* Charts and visualizations */
      .dark canvas {
        background-color: #2d2d2d;
      }

      /* Loading states */
      .dark .bg-gray-900.bg-opacity-50 {
        background-color: rgba(0, 0, 0, 0.7);
      }

      /* Transitions */
      .dark * {
        transition-property: background-color, border-color, color, fill, stroke;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 150ms;
      }

      /* Override inline styles in dark mode for navbar links */
      /* Removing potentially problematic override */
      /* html.dark .nav-link {
        color: white !important;
      } */

      /* Global styles */
      :root {
        /* Light theme (default) */
        --bg-primary: #ffffff;
        --bg-secondary: #f3f4f6;
        --text-primary: #1f2937;
        --text-secondary: #1f2937; /* Darker color for better contrast */
        --accent-color: #3b82f6;
        --accent-hover: #2563eb;
        --card-bg: #ffffff;
        --card-border: #e5e7eb;
        --nav-bg: #ffffff;
        --card-shadow: rgba(0, 0, 0, 0.1);
        --input-bg: #f9fafb;
        --input-border: #d1d5db;
        --button-primary: #3b82f6;
        --button-hover: #2563eb;
        --button-text: #ffffff;
        --nav-bg: #ffffff;
        --nav-shadow: rgba(0, 0, 0, 0.05);
      }

      /* Dark theme variables */
      .dark {
        --bg-primary: #111827;
        --bg-secondary: #1f2937;
        --text-primary: #f9fafb;
        --text-secondary: #e5e7eb;
        --accent-color: #3b82f6;
        --accent-hover: #60a5fa;
        --card-bg: #1f2937;
        --card-border: #374151;
        --card-shadow: rgba(0, 0, 0, 0.5);
        --input-bg: #374151;
        --input-border: #4b5563;
        --button-primary: #3b82f6;
        --button-hover: #60a5fa;
        --button-text: #ffffff;
        --nav-bg: #111827;
        --nav-shadow: rgba(0, 0, 0, 0.3);
      }

      /* Apply theme variables to elements */
      body {
        background-color: var(--bg-primary);
        color: var(--text-primary);
        transition: background-color 0.3s ease, color 0.3s ease;
      }

      .card,
      .recommendation-item-card,
      .hospital-suggestion-card {
        background-color: var(--card-bg);
        border-color: var(--card-border);
        box-shadow: 0 2px 4px var(--card-shadow);
      }

      input,
      textarea,
      select {
        background-color: var(--input-bg);
        border-color: var(--input-border);
        color: var(--text-primary);
      }

      .navbar {
        background-color: var(--nav-bg);
        box-shadow: 0 2px 4px var(--nav-shadow);
      }

      /* Fix for heading color in light mode */
      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        color: var(--text-primary);
      }

      /* Global heading fix for light mode */
      html:not(.dark) h1,
      html:not(.dark) h2,
      html:not(.dark) h3,
      html:not(.dark) h4,
      html:not(.dark) h5,
      html:not(.dark) h6 {
        color: #000000;
      }

      /* Exceptions for headings that should remain white regardless of theme */
      .hero-section h1, 
      [class*="bg-gradient"] h1,
      [class*="bg-blue"] h1,
      [class*="bg-indigo"] h1,
      [class*="bg-purple"] h1,
      [style*="background"] h1,
      .text-white.hero-heading,
      /* Some sections that explicitly need white text */
      #hero-section h1 {
        color: white !important;
      }

      /* Override for light theme specific headings */
      html:not(.dark) .light\:text-gray-800 {
        color: #1f2937 !important;
      }

      /* Footer and other sections with specific text colors */
      footer h1,
      footer h2,
      footer h3,
      footer h4,
      footer h5,
      footer h6 {
        color: inherit;
      }

      /* Remove any hardcoded dark/light styles that might override theme variables */
      .dark .bg-white,
      .dark .bg-gray-100 {
        background-color: var(--bg-primary) !important;
      }

      /* Fix for bg-white getting incorrect background in light mode */
      html:not(.dark) .bg-white {
        background-color: #ffffff !important;
      }

      html:not(.dark) .bg-gray-50 {
        background-color: #f9fafb !important;
      }

      html:not(.dark) .bg-gray-100 {
        background-color: #f3f4f6 !important;
      }

      html:not(.dark) .bg-gray-800 {
        background-color: #1f2937 !important; /* Only apply in dark mode */
      }

      .dark .text-gray-800,
      .dark .text-gray-900 {
        color: var(--text-primary) !important;
      }

      .dark .border-gray-200,
      .dark .border-gray-300 {
        border-color: var(--card-border) !important;
      }

      /* Direct fix for white text on white background in light theme */
      html:not(.dark)
        h1.text-white:not([class*="hero-heading"]):not([class*="light:"]),
      html:not(.dark)
        h2.text-white:not([class*="hero-heading"]):not([class*="light:"]),
      html:not(.dark)
        h3.text-white:not([class*="hero-heading"]):not([class*="light:"]),
      html:not(.dark)
        h4.text-white:not([class*="hero-heading"]):not([class*="light:"]),
      html:not(.dark)
        h5.text-white:not([class*="hero-heading"]):not([class*="light:"]),
      html:not(.dark)
        h6.text-white:not([class*="hero-heading"]):not([class*="light:"]) {
        color: var(--text-primary) !important;
      }

      /* Specific fixes for any remaining issues */
      html:not(.dark)
        [class*="text-white"]:not([class*="hero"]):not([class*="bg-"]):not(
          [id*="hero"]
        ):not(button):not(a) {
        color: var(--text-primary) !important;
      }

      /* Override for dark blue sections in light theme */
      html:not(.dark) .bg-blue-600 h1:not([class*="text-white"]),
      html:not(.dark) .bg-blue-700 h1:not([class*="text-white"]),
      html:not(.dark) .bg-indigo-600 h1:not([class*="text-white"]),
      html:not(.dark) .bg-indigo-700 h1:not([class*="text-white"]) {
        color: white !important;
      }

      /* Fix for light gray text in light mode */
      html:not(.dark) .text-gray-400 {
        color: #4b5563 !important; /* Darker than default */
      }

      html:not(.dark) .text-gray-500 {
        color: #374151 !important; /* Darker than default */
      }

      html:not(.dark) .text-gray-300,
      html:not(.dark) .text-gray-200 {
        color: #1f2937 !important; /* Much darker for better visibility */
      }

      /* Make profile section text darker in light mode */
      html:not(.dark) .profile-section .text-gray-500,
      html:not(.dark) .profile-section .text-gray-400,
      html:not(.dark) .profile-section p,
      html:not(.dark) .profile-card .text-gray-500,
      html:not(.dark) .profile-card .text-gray-400,
      html:not(.dark) .profile-card p {
        color: #1f2937 !important;
      }

      /* Ensure sufficient contrast for all text in light mode */
      html:not(.dark) p,
      html:not(.dark) span:not(.badge):not(.icon):not([class*="bg-"]) {
        color: #1f2937;
      }

      /* Ensure form labels and other UI text are visible */
      html:not(.dark) label,
      html:not(.dark) .text-sm {
        color: #1f2937;
      }

      /* Light theme enhancements for better text contrast */
      .text-gray-700 {
        color: #374151 !important;
      }

      /* Fix for dark background in light theme */
      html:not(.dark) .bg-gray-700,
      html:not(.dark) .bg-gray-800,
      html:not(.dark) .bg-gray-900 {
        background-color: #f3f4f6 !important; /* Light gray in light mode */
      }

      /* Fix specifically for containers in analyze, history and profile pages */
      html:not(.dark) .max-w-2xl.mx-auto.bg-white,
      html:not(.dark) .max-w-2xl.mx-auto.bg-gray-800,
      html:not(.dark) .max-w-7xl.mx-auto.bg-white,
      html:not(.dark) .max-w-7xl.mx-auto.bg-gray-800,
      html:not(.dark) .profile-card.bg-white,
      html:not(.dark) .profile-card.bg-gray-800 {
        background-color: #ffffff !important;
        color: #1f2937 !important;
      }

      /* Fix for the Dashboard heading in light mode */
      html:not(.dark) h1.text-white.mb-6,
      html:not(.dark) h1.text-white.mb-8,
      html:not(.dark) .dashboard-header h1,
      html:not(.dark) h1.dashboard-title,
      html:not(.dark)
        h1:not([class*="hero"]):not([class*="bg-"]):not([id*="hero"]) {
        color: #111827 !important; /* Almost black for maximum visibility */
      }

      /* Fix for file upload area in light mode */
      html:not(.dark) .bg-gray-50,
      html:not(.dark) .dark\:bg-gray-700 {
        background-color: #f9fafb !important;
      }

      html:not(.dark) .dark\:hover\:bg-gray-600:hover {
        background-color: #f3f4f6 !important;
      }
    </style>
  </head>
  <body
    class="font-sans antialiased"
    style="background-color: var(--bg-primary); color: var(--text-primary)"
  >
    <!-- Navigation -->
    <nav
      class="shadow-md sticky top-0 z-50"
      style="
        background-color: var(--nav-bg);
        box-shadow: 0 2px 4px var(--nav-shadow);
      "
    >
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <!-- Left side with logo and navigation links -->
          <div class="flex items-center">
            <div class="flex-shrink-0 flex items-center">
              <a
                href="{{ url_for('index') }}"
                class="text-2xl font-bold transition-colors duration-300"
                style="color: var(--accent-color)"
              >
                CataraQt
              </a>
            </div>
            <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
              <a
                href="{{ url_for('index') }}"
                class="nav-link border-transparent inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-all duration-300 hover:-translate-y-0.5"
                style="color: var(--text-secondary)"
              >
                Home
              </a>
              {% if session.get('user_id') %}
              <a
                href="{{ url_for('analyze_image') }}"
                class="nav-link border-transparent inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-all duration-300 hover:-translate-y-0.5"
                style="color: var(--text-secondary)"
              >
                Analyze
              </a>
              <a
                href="{{ url_for('history') }}"
                class="nav-link border-transparent inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-all duration-300 hover:-translate-y-0.5"
                style="color: var(--text-secondary)"
              >
                History
              </a>
              {% endif %}
              <a
                href="{{ url_for('hospitals') }}"
                class="nav-link border-transparent inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-all duration-300 hover:-translate-y-0.5"
                style="color: var(--text-secondary)"
              >
                Eye Hospitals
              </a>
            </div>
          </div>

          <!-- Right-side container with theme toggle and links -->
          <div class="flex items-center space-x-4">
            <!-- Theme Toggle -->
            <button
              id="theme-toggle"
              class="nav-link p-2 rounded-lg transition-all duration-300 hover:-translate-y-0.5"
              style="color: var(--text-secondary)"
              aria-label="Toggle dark mode"
            >
              <!-- Sun icon (shown in dark mode) -->
              <svg
                id="sun-icon"
                class="w-5 h-5 {% if session.get('theme') != 'dark' %}hidden{% endif %}"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                ></path>
              </svg>
              <!-- Moon icon (shown in light mode) -->
              <svg
                id="moon-icon"
                class="w-5 h-5 {% if session.get('theme') == 'dark' %}hidden{% endif %}"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                ></path>
              </svg>
            </button>

            {% if session.get('user_id') %}
            <!-- Logged-in menu items -->
            <span
              class="text-sm font-medium animate-slide-right"
              style="color: var(--text-primary)"
            >
              Welcome, {{ session.get('user_name', session.get('user_id')) }}
            </span>
            <a
              href="{{ url_for('dashboard') }}"
              class="nav-link px-3 py-2 rounded-md text-sm font-medium transition-all duration-300 hover:-translate-y-0.5"
              style="color: var(--text-secondary)"
            >
              Dashboard
            </a>
            <a
              href="{{ url_for('profile') }}"
              class="nav-link p-0 flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-800 rounded-full"
              aria-label="User Profile"
            >
              {% if session.get('user_profile_picture') %}
              <img
                class="h-8 w-8 rounded-full object-cover hover:opacity-80 transition-opacity duration-300"
                src="{{ url_for('serve_upload', filename=session.get('user_profile_picture')) }}"
                alt="User profile picture"
              />
              {% else %} {# Default SVG icon as inline image data #}
              <img
                class="h-8 w-8 rounded-full transition-colors duration-300"
                style="color: var(--text-secondary)"
                src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBjbGFzcz0iY3NzLWR6YWx2ZiI+PHBhdGggZD0iTTE2IDdjLTEuOTQgMC0zLjUgMS43OS0zLjUgNC41VjE0YTcgNyAwIDEgMCA3IDBoMCAxLjY4NmEyIDIgMCAwIDAtMS45ODEtMS43NTRsMCAuMDAxQTMuNSA0LjUgMCAwIDAgMTYgN3oiPjwvcGF0aD48cGF0aCBkPSJNNCAxMmMwIDQuNDIgMy41OCA4IDggOHMxLjU3LS41IDMuMDMtMS4zMCI+PC9wYXRoPjwvc3ZnPg=="
                alt="Default profile icon"
              />
              {% endif %}
            </a>
            <a
              href="{{ url_for('logout') }}"
              class="nav-link px-3 py-2 rounded-md text-sm font-medium transition-all duration-300 hover:-translate-y-0.5"
              style="color: var(--text-secondary)"
            >
              Logout
            </a>
            {% else %}
            <!-- Logged-out menu items -->
            <a
              href="{{ url_for('login') }}"
              class="nav-link px-3 py-2 rounded-md text-sm font-medium transition-all duration-300 hover:-translate-y-0.5"
              style="color: var(--text-secondary)"
            >
              Login
            </a>
            <a
              href="{{ url_for('register') }}"
              class="btn-primary bg-blue-600 text-white hover:bg-blue-700 px-4 py-2 rounded-md text-sm font-medium shadow-md transition-all duration-300 hover:-translate-y-0.5 hover:shadow-lg"
            >
              Register
            </a>
            {% endif %}
          </div>
        </div>
      </div>
    </nav>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %} {% if
    messages %}
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-4">
      {% for category, message in messages %}
      <div
        class="animate-slide-right rounded-md p-4 mb-4"
        style="background-color: {% if category == 'error' %}rgba(239, 68, 68, 0.1){% else %}rgba(16, 185, 129, 0.1){% endif %}; color: {% if category == 'error' %}#ef4444{% else %}#10b981{% endif %}; {% if request.cookies.get('theme') == 'dark' %}background-color: {% if category == 'error' %}rgba(239, 68, 68, 0.2){% else %}rgba(16, 185, 129, 0.2){% endif %}; color: {% if category == 'error' %}#f87171{% else %}#34d399{% endif %};{% endif %}"
      >
        {{ message }}
      </div>
      {% endfor %}
    </div>
    {% endif %} {% endwith %}

    <!-- Main Content -->
    <main class="flex-grow animate-fade-up">
      {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer
      class="mt-12 animate-fade-up"
      style="
        background-color: var(--bg-primary);
        border-color: var(--card-border);
      "
    >
      <div class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
        <div
          class="mt-8 border-t pt-8 md:flex md:items-center md:justify-between"
          style="border-color: var(--card-border)"
        >
          <div class="flex space-x-6 md:order-2">
            <a
              href="https://github.com/sreeshanth-soma/CataraQt"
              class="hover:text-gray-500 transition-colors duration-300"
              style="color: var(--text-secondary)"
            >
              <span class="sr-only">GitHub</span>
              <svg
                class="h-6 w-6"
                fill="currentColor"
                viewBox="0 0 24 24"
                aria-hidden="true"
              >
                <path
                  fill-rule="evenodd"
                  d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z"
                  clip-rule="evenodd"
                />
              </svg>
            </a>
          </div>
          <p
            class="mt-8 text-base md:mt-0 md:order-1"
            style="color: var(--text-secondary)"
          >
            &copy; 2024 CataraQt. All rights reserved.
          </p>
        </div>
      </div>
    </footer>

    {% block scripts %}{% endblock %}

    <!-- Dark mode script -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Set initial flag to prevent unnecessary server sync on page load
        window.initialThemeLoad = true;

        // Get theme preference from localStorage or system preference
        function getThemePreference() {
          const savedTheme = localStorage.getItem("theme");
          if (savedTheme) {
            return savedTheme;
          }
          return window.matchMedia("(prefers-color-scheme: dark)").matches
            ? "dark"
            : "light";
        }

        // Set a cookie
        function setCookie(name, value, days) {
          let expires = "";
          if (days) {
            const date = new Date();
            date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
            expires = "; expires=" + date.toUTCString();
          }
          document.cookie = name + "=" + (value || "") + expires + "; path=/";
        }

        // Sync theme with server
        function syncThemeWithServer(theme) {
          // Skip server sync on initial page load to avoid unnecessary requests
          if (window.initialThemeLoad) {
            window.initialThemeLoad = false;
            return;
          }

          fetch("/set-theme", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ theme: theme }),
          })
            .then((response) => {
              if (!response.ok) {
                console.log(
                  "Theme sync response not OK, falling back to client-side only"
                );
              }
              return response.json().catch(() => ({}));
            })
            .catch((error) => {
              console.log(
                "Error syncing theme, using client-side only:",
                error
              );
              // Still apply theme locally even if server sync fails
              applyThemeToDOM(theme);
            });
        }

        // DOM manipulation for theme (extracted to separate function)
        function applyThemeToDOM(theme) {
          if (theme === "dark") {
            document.documentElement.classList.add("dark");
            document.body.classList.add("dark");
            document.getElementById("sun-icon").classList.remove("hidden");
            document.getElementById("moon-icon").classList.add("hidden");
          } else {
            document.documentElement.classList.remove("dark");
            document.body.classList.remove("dark");
            document.getElementById("sun-icon").classList.add("hidden");
            document.getElementById("moon-icon").classList.remove("hidden");
          }
        }

        // Apply theme to HTML and document elements
        function setTheme(theme) {
          // Apply DOM changes
          applyThemeToDOM(theme);

          // Store in local storage
          localStorage.setItem("theme", theme);

          // Store in cookie for server-side rendering
          setCookie("theme", theme, 365); // Store in cookie for 1 year

          // Try to sync with server, but don't block on it
          syncThemeWithServer(theme);
        }

        // Initialize theme
        const currentTheme = getThemePreference();
        setTheme(currentTheme);

        // Handle theme toggle button click
        document
          .getElementById("theme-toggle")
          .addEventListener("click", function () {
            const isDark = document.documentElement.classList.contains("dark");
            setTheme(isDark ? "light" : "dark");
          });

        // Listen for system theme changes
        window
          .matchMedia("(prefers-color-scheme: dark)")
          .addEventListener("change", function (e) {
            if (!localStorage.getItem("theme")) {
              setTheme(e.matches ? "dark" : "light");
            }
          });
      });
    </script>
  </body>
</html>
